<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InstaCarousel Pro</title>

    <!-- 1. TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Phosphor Icons (Ahorra líneas y pesa poco) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 3. Quill.js & html2canvas -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.core.css" rel="stylesheet">

    <!-- Configuración -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#1E1E1E',      /* Dark Grey (Gmail Dark) */
                        text: '#E3E3E3',    /* Off White */
                        primary: '#8AB4F8', /* Google Blue */
                        surface: '#303134', /* Surface borders */
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    aspectRatio: {
                        'ig': '4 / 5',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CORE STYLES */
        body { background-color: #1E1E1E; color: #E3E3E3; font-family: 'Roboto', sans-serif; overflow: hidden; }
        
        /* Área de Trabajo */
        #workspace { 
            height: calc(100vh - 120px); /* Resta Header + Toolbar */
            overflow-y: auto; 
            scrollbar-width: none; 
        }
        #workspace::-webkit-scrollbar { display: none; }

        /* QUILL OVERRIDES (Tipografía corregida) */
        .ql-editor {
            padding: 2rem;
            font-family: 'Roboto', sans-serif;
            color: #E3E3E3;
            overflow-y: hidden; /* El texto manda el tamaño si fuera necesario, pero aquí restringimos */
        }
        .ql-editor.ql-blank::before { color: #5F6368; font-style: normal; left: 2rem; }
        
        /* Escala Tipográfica Controlada (Ni muy grande ni muy chica) */
        .ql-editor p { font-size: 1.125rem; line-height: 1.6; margin-bottom: 0.5rem; }
        .ql-editor h1 { font-size: 1.85rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.5rem; }
        .ql-editor h2 { font-size: 1.5rem; font-weight: 500; line-height: 1.3; margin-bottom: 0.5rem; }
        
        /* Selección y Cursor */
        ::selection { background: rgba(138, 180, 248, 0.3); color: #8AB4F8; }
        .ql-cursor { border-left-color: #8AB4F8 !important; }

        /* UI Elements */
        .btn-icon { @apply p-3 rounded-lg text-2xl transition-colors text-gray-400 hover:text-white flex items-center justify-center; }
        .btn-icon.active { @apply text-primary bg-primary/10; }
        
        /* Slide Container */
        .slide-wrapper {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .slide-wrapper.focused {
            box-shadow: 0 0 0 2px #8AB4F8; /* Focus ring estilo Google */
        }
    </style>
</head>
<body class="flex flex-col min-h-dvh">

    <!-- HEADER -->
    <header class="h-14 border-b border-surface bg-bg flex justify-between items-center px-4 shrink-0 z-20">
        <div class="font-bold text-lg tracking-wide">Insta<span class="text-primary">Draft</span></div>
        <div class="flex gap-2">
            <button onclick="app.addSlide()" class="bg-surface hover:bg-white/10 text-white px-3 py-1.5 rounded text-sm font-medium transition flex items-center gap-1">
                <i class="ph ph-plus-circle text-lg"></i> Slide
            </button>
            <button onclick="app.export()" id="exportBtn" class="bg-primary hover:bg-blue-400 text-bg px-4 py-1.5 rounded text-sm font-bold transition flex items-center gap-2">
                <i class="ph ph-download-simple text-lg"></i> Exportar
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <main id="workspace" class="flex flex-col items-center py-6 px-4 gap-8">
        <!-- Slides dinámicos -->
    </main>

    <!-- TOOLBAR (Gmail Style) -->
    <div class="h-16 border-t border-surface bg-bg flex justify-center items-center shrink-0 w-full z-30 pb-safe">
        <div class="flex items-center gap-1 sm:gap-4 px-2">
            
            <button class="btn-icon" data-cmd="format" data-arg="bold">
                <i class="ph ph-text-b"></i>
            </button>
            
            <button class="btn-icon" data-cmd="format" data-arg="italic">
                <i class="ph ph-text-italic"></i>
            </button>

            <!-- Size Cycler (P -> H1 -> H2) -->
            <button class="btn-icon w-12" id="sizeBtn">
                <span class="font-serif font-bold text-xl">Tt</span>
            </button>

            <div class="w-px h-6 bg-surface mx-1"></div>

            <!-- Align Cycler -->
            <button class="btn-icon" id="alignBtn">
                <i class="ph ph-text-align-left"></i>
            </button>

            <!-- Color Toggle -->
            <button class="btn-icon text-primary" id="colorBtn">
                <i class="ph ph-drop-half-bottom"></i>
            </button>

            <div class="w-px h-6 bg-surface mx-1"></div>

            <!-- Insert Arrow ➤ -->
            <button class="btn-icon text-yellow-400" id="symbolBtn">
                <span class="text-xl leading-none">➤</span>
            </button>

        </div>
    </div>

    <!-- APP LOGIC -->
    <script>
        class CarouselApp {
            constructor() {
                this.slides = [];
                this.activeQuill = null;
                this.workspace = document.getElementById('workspace');
                
                // Logic Lists
                this.sizes = [false, '1', '2']; // false=P, 1=H1, 2=H2
                this.sizeLabels = ['Tt', 'T1', 'T2']; // Visual feedback could be added
                this.sizeIdx = 0;

                this.aligns = [false, 'center', 'right']; 
                this.alignIcons = ['ph-text-align-left', 'ph-text-align-center', 'ph-text-align-right'];
                this.alignIdx = 0;

                // Symbols to cycle or insert
                this.symbol = "➤"; 

                this.init();
            }

            init() {
                this.addSlide();
                this.setupToolbar();
            }

            addSlide() {
                const id = `slide-${Date.now()}`;
                
                // Wrapper (4:5 Aspect Ratio)
                // Usamos w-full max-w-[360px] para simular ancho de móvil
                const wrapper = document.createElement('div');
                wrapper.className = 'slide-wrapper w-full max-w-[360px] aspect-ig bg-bg border border-surface relative flex flex-col group';
                wrapper.id = `wrap-${id}`;

                // Botón Borrar (Solo visible en hover o si es el activo)
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<i class="ph ph-x"></i>';
                closeBtn.className = 'absolute -right-3 -top-3 w-7 h-7 bg-surface text-white rounded-full flex items-center justify-center shadow-lg z-10 opacity-0 group-hover:opacity-100 transition-opacity';
                closeBtn.onclick = (e) => { e.stopPropagation(); this.removeSlide(id); };

                // Editor Container
                const editor = document.createElement('div');
                editor.id = id;
                editor.className = 'h-full';

                wrapper.appendChild(closeBtn);
                wrapper.appendChild(editor);
                this.workspace.appendChild(wrapper);

                // Quill Init
                const quill = new Quill(`#${id}`, {
                    modules: { toolbar: false },
                    theme: 'snow'
                });

                // Events
                quill.on('selection-change', (range) => {
                    if (range) {
                        this.setActive(quill, wrapper);
                    }
                });

                wrapper.addEventListener('click', () => quill.focus());

                this.slides.push({ id, quill, wrapper });
                
                // Auto Focus
                setTimeout(() => quill.focus(), 50);
            }

            setActive(quill, wrapper) {
                this.activeQuill = quill;
                
                // Visual Focus Ring
                document.querySelectorAll('.slide-wrapper').forEach(el => el.classList.remove('focused'));
                wrapper.classList.add('focused');

                this.updateToolbar();
            }

            removeSlide(id) {
                if (this.slides.length <= 1) return;
                const idx = this.slides.findIndex(s => s.id === id); // Fix: use id property
                if (idx > -1) {
                    this.slides[idx].wrapper.remove();
                    this.slides.splice(idx, 1);
                }
            }

            setupToolbar() {
                // Formatos Simples
                document.querySelectorAll('[data-cmd="format"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if(!this.activeQuill) return;
                        const fmt = btn.dataset.arg;
                        const current = this.activeQuill.getFormat()[fmt];
                        this.activeQuill.format(fmt, !current);
                        this.updateToolbar();
                    });
                });

                // Size Toggle
                document.getElementById('sizeBtn').addEventListener('click', () => {
                    if(!this.activeQuill) return;
                    this.sizeIdx = (this.sizeIdx + 1) % this.sizes.length;
                    this.activeQuill.format('header', this.sizes[this.sizeIdx]);
                    this.updateToolbar();
                });

                // Align Toggle
                const alignBtn = document.getElementById('alignBtn');
                alignBtn.addEventListener('click', () => {
                    if(!this.activeQuill) return;
                    this.alignIdx = (this.alignIdx + 1) % this.aligns.length;
                    this.activeQuill.format('align', this.aligns[this.alignIdx]);
                    
                    // Icon Update
                    const icon = alignBtn.querySelector('i');
                    icon.className = `ph ${this.alignIcons[this.alignIdx]}`;
                    
                    this.updateToolbar();
                });

                // Color Toggle (Primary)
                const colorBtn = document.getElementById('colorBtn');
                colorBtn.addEventListener('click', () => {
                    if(!this.activeQuill) return;
                    const isColored = this.activeQuill.getFormat().color === '#8AB4F8';
                    this.activeQuill.format('color', isColored ? false : '#8AB4F8');
                    this.updateToolbar();
                });

                // Insert Symbol
                document.getElementById('symbolBtn').addEventListener('click', () => {
                    if(!this.activeQuill) return;
                    const selection = this.activeQuill.getSelection(true);
                    // Insertar con espacio
                    this.activeQuill.insertText(selection.index, this.symbol + " "); 
                    // Mover cursor
                    this.activeQuill.setSelection(selection.index + 2);
                });
            }

            updateToolbar() {
                if(!this.activeQuill) return;
                const fmt = this.activeQuill.getFormat();

                // Toggle active classes
                document.querySelector('[data-arg="bold"]').classList.toggle('active', fmt.bold);
                document.querySelector('[data-arg="italic"]').classList.toggle('active', fmt.italic);
                document.getElementById('colorBtn').classList.toggle('active', fmt.color === '#8AB4F8');
            }

            async export() {
                const btn = document.getElementById('exportBtn');
                const prevHtml = btn.innerHTML;
                btn.innerHTML = '<i class="ph ph-spinner animate-spin text-lg"></i> Procesando';
                btn.disabled = true;

                try {
                    const EXPORT_W = 1080;
                    const EXPORT_H = 1350;

                    for (let i = 0; i < this.slides.length; i++) {
                        const { wrapper } = this.slides[i];
                        
                        // 1. Limpieza UI para la foto
                        const closeBtn = wrapper.querySelector('button');
                        closeBtn.style.display = 'none';
                        wrapper.classList.remove('focused'); // Quitar borde azul
                        wrapper.style.borderColor = 'transparent'; // Quitar borde gris

                        // 2. Cálculo de Escala Alta
                        // Capturamos a una resolución mayor que la pantalla pero proporcional
                        const rect = wrapper.getBoundingClientRect();
                        const scale = EXPORT_W / rect.width;

                        // 3. Captura Cruda
                        const canvasRaw = await html2canvas(wrapper, {
                            scale: scale, 
                            backgroundColor: '#1E1E1E',
                            useCORS: true,
                            logging: false,
                            allowTaint: true
                        });

                        // 4. Re-escalado Preciso (Canvas 2D API)
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = EXPORT_W;
                        finalCanvas.height = EXPORT_H;
                        const ctx = finalCanvas.getContext('2d');
                        
                        // Dibujamos el canvas crudo en el canvas final de dimensiones exactas
                        ctx.drawImage(canvasRaw, 0, 0, EXPORT_W, EXPORT_H);

                        // 5. Descargar
                        const a = document.createElement('a');
                        a.href = finalCanvas.toDataURL('image/jpeg', 0.95);
                        a.download = `post-${i+1}.jpg`;
                        a.click();

                        // Restaurar UI
                        closeBtn.style.display = '';
                        wrapper.style.borderColor = ''; // Vuelve a clase original por CSS

                        // Pequeño delay para no congelar la UI
                        await new Promise(r => setTimeout(r, 200));
                    }

                } catch (e) {
                    console.error(e);
                    alert("Error en exportación");
                } finally {
                    btn.innerHTML = prevHtml;
                    btn.disabled = false;
                }
            }
        }

        // Run
        window.app = new CarouselApp();
    </script>
</body>
</html>
